name: Build and Publish to NuGet

on:
  push:
    branches:
      - master

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Generate version based on date
        run: echo "PACKAGE_VERSION=$(date +'%Y.%m.%d').${{ github.run_number }}" >> $GITHUB_ENV

      - name: Restore dependencies
        run: |
          for sln in $(find . -name "*.sln"); do
            echo "Restoring $sln"
            dotnet restore "$sln"
          done

      - name: Pack all solutions
        run: |
          mkdir -p out
          for sln in $(find . -name "*.sln"); do
            echo "Packing $sln"
            dotnet pack "$sln" --configuration Release --output out -p:PackageVersion=${{ env.PACKAGE_VERSION }}
          done

      - name: Find projects with <PublishPackage>true</PublishPackage>
        id: find_projects
        run: |
          {
            echo "projects<<EOF"
            find . -name "*.csproj" -exec grep -l "<PublishPackage>true</PublishPackage>" {} \;
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Push selected packages to NuGet
        run: |
          readarray -t PROJECTS <<< "${{ steps.find_projects.outputs.projects }}"
          for proj in "${PROJECTS[@]}"; do
            id=$(basename "$proj" .csproj)
            pkg="out/$id.${{ env.PACKAGE_VERSION }}.nupkg"
            if [[ -f "$pkg" ]]; then
              echo "Pushing $pkg"
              dotnet nuget push "$pkg" --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY }}
            else
              echo "WARNING: $pkg not found — skipping"
            fi
          done